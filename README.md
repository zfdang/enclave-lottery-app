# Enclave Lottery App

Passive, event‑driven lottery operator + React frontend for an Ethereum smart contract. Runs in plain Docker or inside AWS Nitro Enclave. Lean design: no cron; the backend polls chain state and reacts.

## Overview

Backend (FastAPI) offers REST + WebSocket and a passive operator that submits draw/refund transactions when conditions are met. Frontend (Vite + React) consumes live updates.

Key pieces:
- `enclave/web_server.py` – FastAPI server, REST, WebSocket, static frontend hosting
- `enclave/lottery/operator.py` – passive draw/refund logic
- `enclave/lottery/event_manager.py` – polls contract and publishes snapshots/events
- `enclave/blockchain/client.py` – Ethereum RPC, logs, views, tx
- `enclave/utils/*` – config, logging, crypto, key injection helpers
- `enclave/frontend` – React app

## Prerequisites

- Python 3.11+
- Node.js 18+ (for frontend build/dev)
- Docker (for container image)
- A running Ethereum RPC (Anvil, Geth, etc.)

## Local development

Backend:
```bash
cd enclave
python -m venv venv && source venv/bin/activate
pip install -r requirements.txt
python main.py
```

Frontend:
```bash
cd enclave/frontend
npm install
npm run dev
```

Default dev proxy points to `http://127.0.0.1:6080` for API and `ws://127.0.0.1:6080/ws/lottery` for WebSocket.

## Build and run with Docker

```bash
./scripts/build_docker.sh
docker run --rm -it --name lottery -p 6080:6080 lottery-app:latest
```

After the container is running, set the operator private key (required for draw/refund):

```bash
python3 scripts/set_operator_key.py --url http://localhost:6080
```

The script encrypts your key with the enclave/server TLS public key and sends it to `POST /api/set_operator_key`.

## Configuration

Preferred: edit `enclave/lottery.conf` and rebuild. Minimal example:

```json
{
   "server": { "host": "0.0.0.0", "port": 6080 },
   "blockchain": {
      "rpc_url": "http://localhost:8545",
      "chain_id": 31337,
      "contract_address": "0x..."
   },
   "enclave": { "attestation_enabled": false },
   "event_manager": {
      "contract_config_interval_sec": 10,
      "round_and_participants_interval_sec": 2
   }
}
```

Environment variables may override specific values (for example `BLOCKCHAIN_RPC_URL`). See `enclave/utils/config.py` and `docs/CONFIG.md` for details.

## REST API (selected)

- `GET /api/health` – service + blockchain health
- `GET /api/status` – summary: current round, participants, history, operator, blockchain
- `GET /api/round/status` – current round snapshot
- `GET /api/round/participants` – participants aggregation
- `GET /api/round/player?player=0x...` – current round amount for address
- `GET /api/history?limit=N` – recent rounds
- `GET /api/activities` – recent activity feed
- `GET /api/contract/config` – on-chain config & derived values
- `GET /api/contract/address` – contract address only
- `GET /api/get_pub_key` – TLS public key for ECIES encryption
- `POST /api/set_operator_key` – inject operator private key (ECIES-encrypted)
- `GET /api/attestation` – Nitro attestation (real if NSM available; otherwise dummy for dev)

WebSocket: `ws://<host>:6080/ws/lottery`

## Operator key injection

1) Fetch TLS public key (the script does this): `GET /api/get_pub_key`
2) Encrypt your EOA private key with ECIES (SECP384R1) and send to `POST /api/set_operator_key`
3) This succeeds only once; subsequent attempts are rejected

See `docs/KEY_INJECTION.md` and `scripts/set_operator_key.py`.

## Attestation

`GET /api/attestation` returns a base64‑encoded CBOR Nitro attestation document and PCRs. In dev environments without NSM device, a dummy document is returned for testing. See `docs/deployment.md` for verification notes.

## Project structure

```
enclave/
   main.py
   web_server.py
   blockchain/
   lottery/
   utils/
   frontend/
contracts/
   Lottery.sol
   compiled/ (generated by build script)
scripts/
   build_docker.sh
   set_operator_key.py
docs/
   CONFIG.md
   deployment.md
   DOCKER_ARCHITECTURE.md
   HYBRID_ARCHITECTURE.md
```

## License

MIT — see `LICENSE`.